image: "rustlang/rust:nightly"

# Use cargo to test the project
test:cargo:
  script:
    - rustc --version && cargo --version  # Print version info for debugging
    - cargo test --workspace --verbose -- --format=json  -Z unstable-options --report-time --ignored | cargo2junit > results.xml
  artifacts:
    when: always
    reports:
      junit: results.xml

variables:
  POSTGRES_HOST_AUTH_METHOD: trust

integration-test:cargo:
  before_script:
    - cargo install cargo2junit
  services:
    - name: hendrikxitc/minerva
      alias: database
  script:
    - rustc --version && cargo --version  # Print version info for debugging
    - PGHOST=database PGUSER=postgres PGDATABASE=minerva cargo test --workspace --verbose -- --format=json  -Z unstable-options --report-time --ignored | cargo2junit > results.xml
  artifacts:
    when: always
    reports:
      junit: results.xml

deploy:
  stage: deploy
  script: echo "Define your deployment script!"
  environment: production


